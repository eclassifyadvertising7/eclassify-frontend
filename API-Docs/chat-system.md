# Chat System - Complete Specification

## Overview

Real-time chat system for buyers and sellers to communicate about listings. Includes offer negotiation, contact sharing, blocking, and reporting features.

## Database Schema

### 1. `chat_rooms` Table

Primary table for chat conversations between buyer and seller about a specific listing.

```sql
CREATE TABLE chat_rooms (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  listing_id BIGINT NOT NULL REFERENCES listings(id) ON DELETE CASCADE,
  buyer_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  seller_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  -- Status
  is_active BOOLEAN DEFAULT true NOT NULL,
  
  -- Message tracking
  last_message_at TIMESTAMP,
  unread_count_buyer INTEGER DEFAULT 0 NOT NULL,
  unread_count_seller INTEGER DEFAULT 0 NOT NULL,
  
  -- User preferences
  is_important_buyer BOOLEAN DEFAULT false NOT NULL,
  is_important_seller BOOLEAN DEFAULT false NOT NULL,
  
  -- Subscription tiers (cached for filtering)
  buyer_subscription_tier VARCHAR(20),
  seller_subscription_tier VARCHAR(20),
  
  -- Contact sharing
  buyer_requested_contact BOOLEAN DEFAULT false NOT NULL,
  seller_shared_contact BOOLEAN DEFAULT false NOT NULL,
  
  -- Blocking & Reporting (JSONB for flexibility)
  blocked_by_buyer BOOLEAN DEFAULT false NOT NULL,
  blocked_by_seller BOOLEAN DEFAULT false NOT NULL,
  block_metadata JSONB,
  -- Structure: {
  --   buyer: {reason: "spam", blockedAt: "2025-11-30T10:00:00Z"},
  --   seller: {reason: "inappropriate", blockedAt: "2025-11-30T11:00:00Z"}
  -- }
  
  reported_by_buyer BOOLEAN DEFAULT false NOT NULL,
  reported_by_seller BOOLEAN DEFAULT false NOT NULL,
  report_metadata JSONB,
  -- Structure: [
  --   {
  --     reportedBy: "buyer",
  --     reportedUser: 123,
  --     type: "spam",
  --     reason: "Sending promotional messages",
  --     reportedAt: "2025-11-30T10:00:00Z",
  --     status: "pending"
  --   }
  -- ]
  
  -- Timestamps
  created_at TIMESTAMP DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP DEFAULT NOW() NOT NULL,
  
  -- Constraints
  CONSTRAINT unique_listing_buyer UNIQUE (listing_id, buyer_id)
);

-- Indexes
CREATE INDEX idx_chat_rooms_buyer ON chat_rooms(buyer_id, is_active);
CREATE INDEX idx_chat_rooms_seller ON chat_rooms(seller_id, is_active);
CREATE INDEX idx_chat_rooms_blocked ON chat_rooms(blocked_by_buyer, blocked_by_seller);
CREATE INDEX idx_chat_rooms_reported ON chat_rooms(reported_by_buyer, reported_by_seller);
```

**Key Points**:
- One room per buyer-listing combination (UNIQUE constraint)
- `is_active` becomes false when listing expires/deleted (read-only mode)
- Subscription tiers cached for fast filtering (elite buyer/seller)
- JSONB for block/report metadata (flexible, not queried frequently)

### 2. `chat_messages` Table

Stores all messages in chat rooms.

```sql
CREATE TABLE chat_messages (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  chat_room_id BIGINT NOT NULL REFERENCES chat_rooms(id) ON DELETE CASCADE,
  sender_id BIGINT REFERENCES users(id) ON DELETE SET NULL,
  
  -- Message content
  message_text TEXT,
  message_type VARCHAR(20) NOT NULL,
  -- Types: 'text', 'image', 'location', 'system'
  
  message_metadata JSONB,
  -- Image: {url, thumbnailUrl, fileName, fileSize, mimeType}
  -- Location: {lat, lng, address}
  -- System: {action, data}
  
  -- Message features
  reply_to_message_id BIGINT REFERENCES chat_messages(id) ON DELETE SET NULL,
  system_event_type VARCHAR(50),
  -- Types: 'offer_made', 'offer_accepted', 'offer_rejected', 
  --        'contact_requested', 'contact_shared', 'user_blocked'
  
  -- Read status (SIMPLE - no delivered status)
  is_read BOOLEAN DEFAULT false NOT NULL,
  read_at TIMESTAMP,
  
  -- Lifecycle
  edited_at TIMESTAMP,
  deleted_at TIMESTAMP,
  
  -- Timestamps
  created_at TIMESTAMP DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP DEFAULT NOW() NOT NULL
);

-- Indexes
CREATE INDEX idx_chat_messages_room ON chat_messages(chat_room_id, created_at DESC);
CREATE INDEX idx_chat_messages_reply ON chat_messages(reply_to_message_id);
CREATE INDEX idx_chat_messages_unread ON chat_messages(chat_room_id, is_read);
```

**Key Points**:
- Simple read status (no sent/delivered complexity)
- Soft delete support (deleted_at)
- Message threading (reply_to_message_id)
- System messages for events (offers, contact sharing, etc.)

### 3. `listing_offers` Table

Tracks price negotiations between buyer and seller.

```sql
CREATE TABLE listing_offers (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  listing_id BIGINT NOT NULL REFERENCES listings(id) ON DELETE CASCADE,
  chat_room_id BIGINT NOT NULL REFERENCES chat_rooms(id) ON DELETE CASCADE,
  buyer_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  seller_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  -- Offer details
  offered_amount DECIMAL(12,2) NOT NULL,
  listing_price_at_time DECIMAL(12,2) NOT NULL,
  discount_percentage DECIMAL(5,2),
  notes TEXT,
  
  -- Negotiation chain
  parent_offer_id BIGINT REFERENCES listing_offers(id) ON DELETE SET NULL,
  -- NULL = initial offer, NOT NULL = counter-offer
  
  -- Status
  status VARCHAR(20) NOT NULL,
  -- Values: 'pending', 'accepted', 'rejected', 'withdrawn', 'expired', 'countered'
  
  -- Lifecycle
  expires_at TIMESTAMP,
  viewed_at TIMESTAMP,
  responded_at TIMESTAMP,
  rejection_reason TEXT,
  auto_rejected BOOLEAN DEFAULT false NOT NULL,
  
  -- Timestamps
  created_at TIMESTAMP DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP DEFAULT NOW() NOT NULL
);

-- Indexes
CREATE INDEX idx_listing_offers_listing ON listing_offers(listing_id, created_at DESC);
CREATE INDEX idx_listing_offers_room ON listing_offers(chat_room_id, created_at DESC);
CREATE INDEX idx_listing_offers_buyer ON listing_offers(buyer_id, status);
CREATE INDEX idx_listing_offers_seller ON listing_offers(seller_id, status);
CREATE INDEX idx_listing_offers_status ON listing_offers(status, expires_at);
CREATE INDEX idx_listing_offers_parent ON listing_offers(parent_offer_id);
```

**Key Points**:
- Tracks full negotiation chain via parent_offer_id
- Status enum for offer lifecycle
- Auto-expiry support (cron job sets auto_rejected)
- Analytics-friendly (listing-level offer tracking)

## Chat Room Lifecycle

### Active States

**Active** (`is_active = true`):
- Normal messaging allowed
- Users can send text, images, locations
- Offers can be made/accepted

**Inactive** (`is_active = false`):
- Read-only mode
- No new messages allowed
- Show "Listing no longer available" banner
- Users can view message history

### Triggers for Inactive

1. Listing expires (30 days)
2. Listing deleted by owner
3. Listing rejected/removed by admin

### Cascade Deletion

- Listing deleted → chat rooms deleted → messages deleted → offers deleted
- User deleted → their chat rooms deleted → messages deleted → offers deleted
- Buyer/seller deletes room → room deleted → messages deleted → offers deleted

## Message Types

### 1. Text Message
```json
{
  "messageType": "text",
  "messageText": "Is this still available?",
  "messageMetadata": null
}
```

### 2. Image Message
```json
{
  "messageType": "image",
  "messageText": "Here's a photo of the damage",
  "messageMetadata": {
    "url": "uploads/chats/room-123/image.jpg",
    "thumbnailUrl": "uploads/chats/room-123/thumb_image.jpg",
    "fileName": "car_photo.jpg",
    "fileSize": 245678,
    "mimeType": "image/jpeg"
  }
}
```

### 3. Location Message
```json
{
  "messageType": "location",
  "messageText": "Let's meet here",
  "messageMetadata": {
    "lat": 28.6139,
    "lng": 77.2090,
    "address": "Connaught Place, New Delhi"
  }
}
```

### 4. System Message
```json
{
  "messageType": "system",
  "systemEventType": "offer_accepted",
  "messageText": "Seller accepted your offer of ₹465,000",
  "messageMetadata": {
    "offerId": 3,
    "amount": 465000
  }
}
```

## Filter System

### Main Filters (User Perspective)

- **all**: All chat rooms (buyer_id = userId OR seller_id = userId)
- **buying**: Rooms where user is buyer (buyer_id = userId)
- **selling**: Rooms where user is seller (seller_id = userId)

### Sub Filters (Applied to Main Filter)

- **all**: No additional filter
- **unread**: Rooms with unread messages (unread_count > 0)
- **important**: User marked as important (is_important_buyer/seller = true)
- **elite_buyer**: Buyer has elite subscription tier
- **elite_seller**: Seller has elite subscription tier

### Query Examples

```sql
-- Buying + Unread
SELECT * FROM chat_rooms 
WHERE buyer_id = 123 
AND unread_count_buyer > 0 
AND is_active = true
ORDER BY last_message_at DESC;

-- Selling + Elite Buyer
SELECT * FROM chat_rooms 
WHERE seller_id = 123 
AND buyer_subscription_tier = 'elite'
AND is_active = true
ORDER BY last_message_at DESC;
```

## API Endpoints

### End-User Chat Routes (`/api/end-user/chats`)

#### Chat Rooms

**GET /rooms**
Get user's chat rooms with filters.

Query Parameters:
- `main`: 'all' | 'buying' | 'selling' (default: 'all')
- `sub`: 'all' | 'unread' | 'important' | 'elite_buyer' | 'elite_seller' (default: 'all')
- `page`: Page number (default: 1)
- `limit`: Items per page (default: 20)

Response:
```json
{
  "success": true,
  "message": "Chat rooms retrieved successfully",
  "data": {
    "rooms": [
      {
        "id": 123,
        "listingId": 456,
        "listingTitle": "2020 Honda City",
        "listingPrice": 500000,
        "listingImage": "http://localhost:5000/uploads/...",
        "isActive": true,
        "otherUser": {
          "id": 789,
          "name": "John Doe",
          "profilePicture": "http://localhost:5000/uploads/...",
          "subscriptionTier": "elite"
        },
        "lastMessage": {
          "text": "Is this still available?",
          "createdAt": "2025-11-30T10:00:00Z"
        },
        "unreadCount": 3,
        "isImportant": false,
        "isBlocked": false,
        "createdAt": "2025-11-29T15:30:00Z"
      }
    ],
    "pagination": {
      "currentPage": 1,
      "totalPages": 5,
      "totalItems": 95,
      "itemsPerPage": 20
    }
  }
}
```

**POST /rooms/create**
Create or get existing chat room for a listing.

Request:
```json
{
  "listingId": 456
}
```

Response:
```json
{
  "success": true,
  "message": "Chat room created successfully",
  "data": {
    "roomId": 123,
    "isNew": true
  }
}
```

**GET /rooms/view/:roomId**
Get specific room details (without messages).

Response:
```json
{
  "success": true,
  "message": "Chat room retrieved successfully",
  "data": {
    "room": {
      "id": 123,
      "listingId": 456,
      "listing": {
        "title": "2020 Honda City",
        "price": 500000,
        "image": "http://localhost:5000/uploads/...",
        "isActive": true
      },
      "otherUser": {
        "id": 789,
        "name": "John Doe",
        "profilePicture": "http://localhost:5000/uploads/..."
      },
      "isActive": true,
      "isBlocked": false,
      "contactShared": false
    }
  }
}
```

**DELETE /rooms/delete/:roomId**
Delete chat room (cascade deletes messages and offers).

Response:
```json
{
  "success": true,
  "message": "Chat room deleted successfully"
}
```

#### Messages

**POST /messages/send/:roomId**
Send a message (text, image, or location).

Request (Text):
```json
{
  "messageType": "text",
  "messageText": "Is this still available?",
  "replyToMessageId": null
}
```

Request (Image - FormData):
```
messageType: "image"
messageText: "Here's a photo"
file: [binary]
```

Request (Location):
```json
{
  "messageType": "location",
  "messageText": "Let's meet here",
  "messageMetadata": {
    "lat": 28.6139,
    "lng": 77.2090,
    "address": "Connaught Place, New Delhi"
  }
}
```

Response:
```json
{
  "success": true,
  "message": "Message sent successfully",
  "data": {
    "messageId": 1001,
    "createdAt": "2025-11-30T10:00:00Z"
  }
}
```

**GET /messages/list/:roomId**
Get messages for a room (paginated).

Query Parameters:
- `page`: Page number (default: 1)
- `limit`: Messages per page (default: 50)

Response:
```json
{
  "success": true,
  "message": "Messages retrieved successfully",
  "data": {
    "messages": [
      {
        "id": 1001,
        "senderId": 789,
        "messageType": "text",
        "messageText": "Is this still available?",
        "isRead": true,
        "readAt": "2025-11-30T10:05:00Z",
        "createdAt": "2025-11-30T10:00:00Z"
      }
    ],
    "pagination": {
      "currentPage": 1,
      "totalPages": 3,
      "totalItems": 142
    }
  }
}
```

**PATCH /messages/edit/:messageId**
Edit own message (within 15 minutes, no replies).

Request:
```json
{
  "messageText": "Updated message text"
}
```

Response:
```json
{
  "success": true,
  "message": "Message updated successfully"
}
```

**DELETE /messages/delete/:messageId**
Soft delete own message.

Response:
```json
{
  "success": true,
  "message": "Message deleted successfully"
}
```

**PATCH /messages/mark-read/:roomId**
Mark all messages in room as read.

Response:
```json
{
  "success": true,
  "message": "Messages marked as read"
}
```

#### Room Actions

**PATCH /rooms/important/:roomId**
Toggle important flag.

Request:
```json
{
  "isImportant": true
}
```

Response:
```json
{
  "success": true,
  "message": "Room marked as important"
}
```

**PATCH /rooms/block/:roomId**
Block/unblock user.

Request:
```json
{
  "blocked": true,
  "reason": "Spam messages"
}
```

Response:
```json
{
  "success": true,
  "message": "User blocked successfully"
}
```

**POST /rooms/report/:roomId**
Report user/room.

Request:
```json
{
  "reportType": "spam",
  "reason": "Sending promotional messages repeatedly"
}
```

Response:
```json
{
  "success": true,
  "message": "Report submitted successfully"
}
```

#### Contact Sharing

**POST /contact/request/:roomId**
Buyer requests seller's contact information.

Response:
```json
{
  "success": true,
  "message": "Contact request sent"
}
```

**POST /contact/share/:roomId**
Seller shares contact information with buyer.

Request:
```json
{
  "phone": "9175113022",
  "email": "seller@example.com"
}
```

Response:
```json
{
  "success": true,
  "message": "Contact information shared"
}
```

#### Offers

**POST /offers/create/:roomId**
Make an offer (buyer) or counter-offer (seller).

Request:
```json
{
  "amount": 450000,
  "notes": "Cash payment, can pick up tomorrow",
  "expiresAt": "2025-12-01T23:59:59Z"
}
```

Response:
```json
{
  "success": true,
  "message": "Offer submitted successfully",
  "data": {
    "offerId": 999,
    "amount": 450000,
    "status": "pending"
  }
}
```

**GET /offers/list/:roomId**
Get all offers for this room (negotiation history).

Response:
```json
{
  "success": true,
  "data": {
    "offers": [
      {
        "id": 1,
        "offeredAmount": 450000,
        "listingPriceAtTime": 500000,
        "discountPercentage": 10.0,
        "status": "countered",
        "notes": "Cash payment",
        "parentOfferId": null,
        "createdAt": "2025-11-30T10:00:00Z"
      },
      {
        "id": 2,
        "offeredAmount": 480000,
        "status": "accepted",
        "parentOfferId": 1,
        "createdAt": "2025-11-30T11:00:00Z"
      }
    ]
  }
}
```

**PATCH /offers/accept/:offerId**
Seller accepts offer.

Response:
```json
{
  "success": true,
  "message": "Offer accepted successfully"
}
```

**PATCH /offers/reject/:offerId**
Seller rejects offer.

Request:
```json
{
  "reason": "Price too low"
}
```

Response:
```json
{
  "success": true,
  "message": "Offer rejected"
}
```

**PATCH /offers/withdraw/:offerId**
Buyer withdraws pending offer.

Response:
```json
{
  "success": true,
  "message": "Offer withdrawn"
}
```

**POST /offers/counter/:offerId**
Seller makes counter-offer.

Request:
```json
{
  "amount": 480000,
  "notes": "Best I can do"
}
```

Response:
```json
{
  "success": true,
  "message": "Counter-offer submitted",
  "data": {
    "offerId": 1000,
    "amount": 480000
  }
}
```

### Panel Routes (`/api/panel/chats`) - Super Admin Only

**GET /rooms/list**
Get all chat rooms with filters.

Query Parameters:
- `reported`: true/false
- `blocked`: true/false
- `hasOffers`: true/false
- `page`, `limit`

Response:
```json
{
  "success": true,
  "data": {
    "rooms": [...],
    "pagination": {...}
  }
}
```

**GET /rooms/view/:roomId**
View any chat room (monitoring).

Response:
```json
{
  "success": true,
  "data": {
    "room": {...},
    "messages": [...],
    "offers": [...]
  }
}
```

**DELETE /rooms/delete/:roomId**
Hard delete chat room.

Response:
```json
{
  "success": true,
  "message": "Chat room deleted permanently"
}
```

**DELETE /messages/delete/:messageId**
Hard delete message (moderation).

Response:
```json
{
  "success": true,
  "message": "Message deleted permanently"
}
```

**GET /reports/list**
Get all reported rooms.

Query Parameters:
- `status`: 'pending' | 'reviewed' | 'resolved' | 'dismissed'
- `page`, `limit`

Response:
```json
{
  "success": true,
  "data": {
    "reports": [
      {
        "roomId": 123,
        "reportedBy": "buyer",
        "reportType": "spam",
        "reason": "...",
        "status": "pending",
        "reportedAt": "2025-11-30T10:00:00Z"
      }
    ],
    "pagination": {...}
  }
}
```

**PATCH /reports/resolve/:roomId**
Mark report as resolved.

Request:
```json
{
  "action": "dismissed",
  "adminNotes": "False report"
}
```

Response:
```json
{
  "success": true,
  "message": "Report resolved"
}
```

**GET /analytics/stats**
Chat statistics.

Response:
```json
{
  "success": true,
  "data": {
    "totalRooms": 1250,
    "activeRooms": 890,
    "totalMessages": 45000,
    "reportedRooms": 12,
    "blockedRooms": 8
  }
}
```

**GET /analytics/offers/top-listings**
Listings with most offers.

Response:
```json
{
  "success": true,
  "data": {
    "listings": [
      {
        "listingId": 456,
        "listingTitle": "2020 Honda City",
        "offerCount": 15,
        "acceptedCount": 2
      }
    ]
  }
}
```

**GET /analytics/offers/trends**
Daily/weekly offer trends.

Response:
```json
{
  "success": true,
  "data": {
    "daily": [
      {"date": "2025-11-30", "count": 45},
      {"date": "2025-11-29", "count": 38}
    ]
  }
}
```

**GET /analytics/offers/acceptance-rate**
Offer acceptance statistics.

Response:
```json
{
  "success": true,
  "data": {
    "totalOffers": 1250,
    "acceptedOffers": 320,
    "acceptanceRate": 25.6
  }
}
```

## Socket.io Events

### Client → Server

**join_room**
```json
{
  "roomId": 123
}
```

**leave_room**
```json
{
  "roomId": 123
}
```

**send_message**
```json
{
  "roomId": 123,
  "messageType": "text",
  "messageText": "Hello",
  "replyToMessageId": null
}
```

**typing**
```json
{
  "roomId": 123
}
```

**stop_typing**
```json
{
  "roomId": 123
}
```

**mark_read**
```json
{
  "roomId": 123
}
```

### Server → Client

**new_message**
```json
{
  "roomId": 123,
  "message": {
    "id": 1001,
    "senderId": 789,
    "messageType": "text",
    "messageText": "Hello",
    "createdAt": "2025-11-30T10:00:00Z"
  }
}
```

**message_read**
```json
{
  "roomId": 123,
  "messageIds": [1001, 1002, 1003],
  "readAt": "2025-11-30T10:05:00Z"
}
```

**message_deleted**
```json
{
  "roomId": 123,
  "messageId": 1001
}
```

**user_typing**
```json
{
  "roomId": 123,
  "userId": 789,
  "userName": "John Doe"
}
```

**user_stop_typing**
```json
{
  "roomId": 123,
  "userId": 789
}
```

**room_inactive**
```json
{
  "roomId": 123,
  "reason": "Listing expired"
}
```

**offer_received**
```json
{
  "roomId": 123,
  "offerId": 999,
  "amount": 450000
}
```

## Business Rules

### Room Creation
- ✅ Listing must exist and be active
- ✅ User cannot chat with themselves (buyer ≠ seller)
- ✅ Return existing room if already exists
- ✅ Cache subscription tiers on creation

### Sending Messages
- ✅ Room must be active (`is_active = true`)
- ❌ Cannot send if listing expired/deleted
- ❌ Cannot send if blocked by other user
- ✅ Update `last_message_at` on room
- ✅ Increment unread count for recipient
- ✅ Emit socket event to recipient

### Inactive Rooms
- ✅ Can view messages
- ❌ Cannot send new messages
- ✅ Show "This listing is no longer available" banner
- ✅ Offer actions disabled

### Blocking
- ✅ Either party can block
- ❌ Blocked users can't send messages
- ✅ Can view existing messages
- ✅ Can unblock anytime
- ✅ Store reason in block_metadata

### Reporting
- ✅ Either party can report
- ✅ Multiple reports stored in report_metadata array
- ✅ Super admin reviews reports
- ✅ Can take action (warn, suspend, delete room)

### Offers
- ✅ Only buyer can make initial offer
- ✅ Only seller can accept/reject/counter
- ✅ Buyer can withdraw pending offer
- ✅ System auto-expires offers (cron job)
- ✅ Max 5 pending offers per buyer per listing
- ✅ Track full negotiation chain via parent_offer_id
- ✅ When offer accepted, create system message

### Contact Sharing
- ✅ Buyer requests, seller decides to share
- ✅ Contact info visible only to buyer (system message)
- ✅ One-time action (can't unshare)
- ✅ Store in system message metadata

### Message Editing
- ✅ Can edit own messages within 15 minutes
- ✅ Show "edited" indicator (edited_at)
- ❌ Can't edit system messages
- ❌ Can't edit if someone replied

### Message Deletion
- ✅ User soft deletes (deleted_at)
- ✅ Super admin hard deletes (remove row)
- ✅ Show "Message deleted" placeholder

## Image Upload in Chat

### Storage Configuration

**Path**: `uploads/chats/room-{roomId}/{timestamp}-{filename}`

**Limits**:
- Max file size: 5MB
- Allowed types: jpg, jpeg, png, webp
- Max dimensions: 1920x1080 (auto-resize)
- Thumbnail: 300x300

### Process Flow

1. Validate file (size, type)
2. Compress with Sharp (quality: 85%)
3. Generate thumbnail (300x300)
4. Store in configured storage (local/Cloudinary)
5. Save relative path in message_metadata
6. Model getter returns full URL

### Multer Configuration

```javascript
const chatUpload = multer({
  storage: storageConfig.getStorage('chats'),
  limits: {fileSize: 5 * 1024 * 1024}, // 5MB
  fileFilter: imageFileFilter
});
```

## Cron Jobs

### Expire Pending Offers

**Schedule**: Every hour

**Logic**:
```sql
UPDATE listing_offers 
SET status = 'expired', auto_rejected = true
WHERE status = 'pending' 
AND expires_at < NOW();
```

**Action**: Create system message in chat room

### Inactive Rooms Cleanup

**Schedule**: Daily at 2 AM

**Logic**:
```sql
UPDATE chat_rooms 
SET is_active = false
WHERE listing_id IN (
  SELECT id FROM listings 
  WHERE status = 'expired' OR deleted_at IS NOT NULL
);
```

## Error Handling

### Common Errors

**404 - Room Not Found**
```json
{
  "success": false,
  "message": "Chat room not found"
}
```

**403 - Access Denied**
```json
{
  "success": false,
  "message": "You don't have access to this chat room"
}
```

**400 - Room Inactive**
```json
{
  "success": false,
  "message": "Cannot send messages. Listing is no longer available."
}
```

**400 - User Blocked**
```json
{
  "success": false,
  "message": "Cannot send messages. User has blocked you."
}
```

**400 - Invalid Offer**
```json
{
  "success": false,
  "message": "Offer amount must be less than listing price"
}
```

## Performance Considerations

### Database Indexes

All critical queries indexed:
- Room lookups by buyer/seller
- Message pagination by room
- Unread message counts
- Offer status queries
- Report filtering

### Caching Strategy

**Redis Cache** (optional, for high traffic):
- Online user status (5 min TTL)
- Unread counts (1 min TTL)
- Active room list (30 sec TTL)

### Pagination

- Messages: 50 per page (load more on scroll)
- Rooms: 20 per page
- Offers: No pagination (typically < 10 per room)

### Socket.io Optimization

- Join only active room (leave on unmount)
- Throttle typing events (500ms)
- Batch read receipts (mark multiple as read)

## Security Considerations

### Access Control

- **Regular users (role: 'user')** can only access rooms where they are buyer OR seller
- **Super admin (role: 'super_admin')** can access ANY room in spectator mode (read-only, logged for audit)
- Validate room ownership on every HTTP request via `validateRoomAccess` middleware
- Validate room ownership on Socket.io connections via `handleJoinRoom` event
- Super admin access is logged for compliance and audit trail

### Spectator Mode (Super Admin)

Super admin has read-only access to all chat rooms for monitoring and moderation:

**Allowed Actions:**
- ✅ View any chat room
- ✅ View all messages in any room
- ✅ Join any room via Socket.io (spectator mode)
- ✅ Delete rooms (for moderation)
- ✅ Delete messages (for moderation)

**Restricted Actions:**
- ❌ Cannot send messages
- ❌ Cannot mark messages as read
- ❌ Cannot emit typing indicators
- ❌ Cannot toggle important flag
- ❌ Cannot block users
- ❌ Cannot report users
- ❌ Cannot make/accept/reject offers
- ❌ Cannot request/share contact information

### Access Validation Flow

```
HTTP Request → JWT Auth → Extract roleSlug → Chat Access Middleware
                                                      ↓
                                    Is super_admin? → YES → Allow (log access)
                                                      ↓
                                                     NO
                                                      ↓
                                    Is buyer/seller? → YES → Allow
                                                      ↓
                                                     NO → 403 Forbidden
```

### Socket.io Security

```
Socket Connection → JWT Auth → Extract roleSlug → Join Room Event
                                                      ↓
                                    Is super_admin? → YES → Join (spectator mode)
                                                      ↓
                                                     NO
                                                      ↓
                                    Is buyer/seller? → YES → Join (normal mode)
                                                      ↓
                                                     NO → Disconnect
```

### Input Validation

- Sanitize message text (XSS prevention)
- Validate image uploads (type, size)
- Validate coordinates (lat/lng ranges)
- Rate limiting on message sending (10 messages/minute)

### Data Privacy

- Contact info only shared when seller approves
- Deleted messages not recoverable by users
- Block metadata private to each user
- Report metadata visible only to admins

## Future Enhancements (Not in MVP)

- Voice messages
- Video calls
- Read receipts with user names
- Message reactions (like, heart)
- Scheduled messages
- Auto-responses for sellers
- Chat templates (quick replies)
- Message search
- Export chat history
- Meeting reminders (push notifications)

## Implementation Checklist

- [ ] Database migrations (3 tables)
- [ ] Sequelize models with associations
- [ ] Repository layer (CRUD operations)
- [ ] Service layer (business logic)
- [ ] Controllers (HTTP handlers)
- [ ] Routes (end-user + panel)
- [ ] Socket.io setup and events
- [ ] Image upload middleware
- [ ] Cron jobs (offer expiry, room cleanup)
- [ ] API documentation
- [ ] Testing (unit + integration)

---

**Document Version**: 1.0  
**Last Updated**: 2025-11-30  
**Status**: Locked for Implementation
